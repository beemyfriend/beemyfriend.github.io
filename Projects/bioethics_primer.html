<head>
    <style>
        div#tooltip{
            position: absolute;
            text-align: left;
            width: 250px;
            height: 20px;
            padding: 5px;
            font-size: 14px;
            background: white;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        
        div#info{
            position: absolute;
            width: 0;
            height: 0;
            padding: 10px;
            font-size: 20px;
            background: white;
            border: 0px;  
            z-index: 0;
        }
        
        div#chart{
            z-index: 1;
        }
        
    </style>
</head>
<body></body>
<script src = 'd3.js'></script>
<script src = 'd3v4+jetpack.js'></script>
<script>
    
    var tooltip = d3.select('body')
        .append('div#tooltip')
        .st({opacity: 0});
    
    var info = d3.select('body')
        .append('div#info')
        .st({opacity: 0});
    
    info.append('div#text');
        
    var svg = d3.select('body')
        .append('div#chart')
        .append('svg')
        .at({width: 1000, height: 700});

    var color = d3.scaleOrdinal()
        .range(['#a6cee3','#1f78b4','#b2df8a','#33a02c'])
        .domain(['Reproductive Ethics', 'Research Ethics', 'Medical Ethics', 'Animal Rights']);    
    
    function network(data){
        var bioethics = data.nodes;
        var links = data.links;
        var nodeHash = bioethics.reduce((hash, node) => {hash[node.id] = node; return hash}, {});
        var normalRadius = 10,
            enlargedRadius = 15,
            normalNodeWidth = 1,
            enlargedNodeWidth = 3,
            normalLinkWidth = 3,
            connectedLinkWidth = 5,
            forceStrength = -150,
            centerX = 500,
            centerY = 350,
            normalLinkStroke = 'black',
            connectedLinkStroke = 'orange',
            tooltipOpacity = .75;

        links.forEach(edge => {
            edge.source = nodeHash[edge.source];
            edge.target = nodeHash[edge.target];
        });
            
        var linkForce = d3.forceLink();
        
        var simulation = d3.forceSimulation()
            .force('charge', d3.forceManyBody().strength(forceStrength))
            .force('center', d3.forceCenter().x(centerX).y(centerY))
            .force('link', linkForce)
            .nodes(bioethics)
            .on('tick', forceTick);
        
        simulation.force('link').links(links);
        
        var linkEnter = svg.appendMany(links, 'line.link')
            .st({opacity: .5, 'stroke-width': normalLinkWidth, stroke: 'black'})
            .on('mouseover', handleLinkHover)
            .on('mouseout', handleLinkOut);
        
        var nodeEnter = svg.appendMany(bioethics, 'g.node');
        
        nodeEnter.append('circle')
            .at({r: normalRadius, id: d =>  d.id})
            .st({fill: d => color(d.tags[0]), stroke: 'black', 'stroke-width': normalNodeWidth, cursor: 'pointer'})
            .on('mouseover', handleMouseOver)
            .on('mouseout', handleMouseOut)
            .on('click', handleNodeClick);        
        
        function forceTick(){
            d3.selectAll('line.link')
                .at({x1: d => d.source.x,
                     x2: d => d.target.x,
                     y1: d => d.source.y,
                     y2: d => d.target.y});
            
            d3.selectAll('g.node')
                .translate(d => [d.x, d.y])
        }
        
        function handleMouseOver(d, i){
            svg.select('circle#' + d.id)
                .at({r: enlargedRadius})
                .st({'stroke-width': enlargedNodeWidth});

            tooltip.st({opacity: tooltipOpacity, left: d3.event.pageX, top: d3.event.pageY})
                .html('<b>' + d.name + '</b>');
            
            linkEnter.filter(p => d.id == p.source.id || d.id == p.target.id)
                .st({stroke: connectedLinkStroke, 'stroke-width': connectedLinkWidth});

        }

        function handleMouseOut(d, i){
            svg.select('circle#' + d.id)
                .at({r: normalRadius})
                .st({'stroke-width': normalNodeWidth})

            linkEnter.filter(p => d.id == p.source.id || d.id == p.target.id)
                .st({stroke: normalLinkStroke, 'stroke-width': normalLinkWidth});
            
            tooltip.st({opacity: 0})
        }
        
        function handleNodeClick(d, i){
            var hoverHtml = `<h1><b>${d.name}</b></h1><br>${d.description}<br><p><i>Reference: <a href =${d.ref[0]}>${d.ref[0]}</a></i></p>`;
            
            info.st({'z-index': 2, opacity: .9, width: 1000, height: 700})
                .select('#text')
                .html(hoverHtml);
        }
        
        function handleLinkHover(d){
            tooltip.st({opacity: tooltipOpacity, left: d3.event.pageX, top: d3.event.pageY})
                .html(d.description);
            
            d3.select(this)
                .st({stroke: connectedLinkStroke, 'stroke-width': connectedLinkWidth})
            
            svg.selectAll('circle')
                .filter(p => { return p.id == d.target.id || p.id == d.source.id})
                .at({r: enlargedRadius})
                .st({'stroke-width': enlargedNodeWidth});
        }
        
        function handleLinkOut(d){
            tooltip.st({opacity: 0})
            
            d3.select(this)
                .st({stroke: normalLinkStroke, 'stroke-width': normalLinkWidth})
                .lower();
            
            svg.selectAll('circle')
                .at({r: normalRadius})
                .st({'stroke-width': normalNodeWidth});
        }
        
        info.on('click', handleInfoClick);
        
        function handleInfoClick(){
            info.st({'z-index': 0, opacity: 0, width: 0, height: 0});
        }
        
    }
    
    d3.json('bioethics.json', network)
</script>